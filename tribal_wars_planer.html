<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Generator Planu Plemiona</title>
    <style>
        :root { --bg: #141414; --panel: #1f1f1f; --border: #333; --accent: #d3ad7f; --text: #e0e0e0; --success: #2e7d32; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }

        #start-screen { max-width: 800px; margin: 50px auto; text-align: center; }
        textarea { width: 100%; height: 300px; background: #222; color: #fff; border: 1px solid #444; padding: 10px; font-family: monospace; border-radius: 5px; resize: vertical; }
        .big-btn { background: var(--accent); color: #000; border: none; padding: 15px 40px; font-size: 1.2em; font-weight: bold; cursor: pointer; border-radius: 5px; margin-top: 20px; transition: 0.2s; }
        .big-btn:hover { background: #fff; }
        
        #main-panel { display: none; max-width: 1400px; margin: 0 auto; }
        .controls { display: flex; gap: 15px; margin-bottom: 20px; background: var(--panel); padding: 15px; border-radius: 8px; border: 1px solid var(--border); }
        button.nav-btn { background: #333; color: white; border: 1px solid #555; padding: 10px 20px; cursor: pointer; border-radius: 4px; font-weight: bold; }
        button.nav-btn.active { background: var(--accent); color: black; border-color: var(--accent); }
        
        .stats { margin-left: auto; color: #888; align-self: center; }
        .progress-bar { height: 4px; background: #333; width: 100%; position: fixed; top: 0; left: 0; z-index: 999; }
        .progress-fill { height: 100%; background: var(--success); width: 0%; transition: 0.5s; }

        .order-row { display: grid; grid-template-columns: 40px 240px 100px 30px 100px 180px 1fr 100px; gap: 10px; background: var(--panel); margin-bottom: 5px; padding: 10px; border-radius: 4px; align-items: center; border-left: 4px solid transparent; transition: 0.2s; }
        .order-row:hover { transform: translateX(5px); background: #2a2a2a; }
        
        .order-number { color: var(--accent); font-weight: bold; font-size: 1.1em; text-align: center; border-right: 1px solid #444; }
        
        .type-FEJK { border-left-color: #569cd6; }
        .type-OFF { border-left-color: #ce9178; }
        .type-GRUBY { border-left-color: #7b1fa2; }
        .done { opacity: 0.3; filter: grayscale(100%); order: 9999; }
        
        .coord { font-family: monospace; font-size: 1.1em; background: #000; padding: 4px 8px; border-radius: 3px; color: #fff; cursor: pointer; text-align: center; }
        .coord:hover { background: var(--accent); color: #000; }
        .time-cell { display: flex; flex-direction: column; line-height: 1.3; }
        .date-part { font-size: 0.8em; color: #888; font-weight: bold; }
        .time-range { font-size: 1.05em; font-weight: bold; color: #fff; }
        
        .link-btn { text-decoration: none; padding: 8px 12px; border-radius: 4px; text-align: center; font-size: 0.9em; font-weight: bold; display: block; color: white; cursor: pointer; }
        .btn-fake { background: #2e7d32; } 
        .btn-off { background: #d32f2f; }
        .btn-nob { background: #7b1fa2; }
        
        .action-btn { background: #444; color: #ddd; border: none; padding: 8px; cursor: pointer; border-radius: 4px; }
        .action-btn:hover { background: #666; }
    </style>
</head>
<body>

    <div id="start-screen">
        <h1>‚öîÔ∏è Generator Rozkaz√≥w Plemiona</h1>
        <p style="color: #888;">Wklej kod JSON ze ≈∫r√≥d≈Ça plenera, aby wygenerowaƒá panel.</p>
        <textarea id="jsonInput" placeholder='Wklej tre≈õƒá JSON tutaj...'></textarea>
        <br>
        <button class="big-btn" onclick="loadData()">GENERUJ PANEL</button>
    </div>

    <div class="progress-bar"><div class="progress-fill" id="progFill"></div></div>

    <div id="main-panel">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h1>Centrum Dowodzenia</h1>
            <button onclick="resetData()" style="background:#552; color:white; border:none; padding:8px 15px; cursor:pointer; border-radius:4px;">Nowa rozpiska (Reset)</button>
        </div>
        
        <div class="controls">
            <button id="btnTime" class="nav-btn active" onclick="setView('time')">üïí Chronologicznie</button>
            <button id="btnVillage" class="nav-btn" onclick="setView('village')">üè† Wg Wiosek</button>
            <div class="stats" id="stats">Wczytywanie...</div>
        </div>
        <div id="app"></div>
    </div>

    <script>
        let orders = [];
        let doneIds = [];
        let currentView = 'time';

        // 1. Logika uruchamiana przy starcie strony
        window.onload = function() {
            const savedData = localStorage.getItem('tw_raw_json');
            const savedDone = localStorage.getItem('tw_done_ids');
            
            if (savedDone) doneIds = JSON.parse(savedDone);
            
            if (savedData) {
                // Je≈õli plan istnieje w pamiƒôci, wype≈Çnij textarea i spr√≥buj go odpaliƒá
                document.getElementById('jsonInput').value = savedData;
                try {
                    const data = JSON.parse(savedData);
                    parseOrders(data);
                    showPanel(); // Przejd≈∫ od razu do widoku planu
                } catch (e) {
                    console.error("B≈ÇƒÖd automatycznego wczytywania planu:", e);
                }
            }
        };

        // 2. Funkcja wywo≈Çywana przyciskiem
        function loadData() {
            const raw = document.getElementById('jsonInput').value;
            try {
                const data = JSON.parse(raw);
                parseOrders(data);
                localStorage.setItem('tw_raw_json', raw);
                showPanel();
            } catch (e) { 
                alert("B≈ÇƒÖd formatu JSON! Upewnij siƒô, ≈ºe kopiujesz poprawnƒÖ tre≈õƒá ze '≈πr√≥d≈Ça'."); 
            }
        }

        // 3. Prze≈ÇƒÖczanie ekran√≥w
        function showPanel() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('main-panel').style.display = 'block';
            setView('time');
        }

        // 4. Przetwarzanie JSON na listƒô obiekt√≥w
        function parseOrders(data) {
            orders = [];
            let internalId = 0;
            const targets = data.targets || [];

            targets.forEach(targetGroup => {
                const tInfo = targetGroup.target || {};
                const tCoord = tInfo.target || '000|000';
                const myOrders = targetGroup.my_orders || [];

                myOrders.forEach(o => {
                    internalId++;
                    const dateStart = o.shipment_t1 ? new Date(o.shipment_t1) : null;
                    const dateEnd = o.shipment_t2 ? new Date(o.shipment_t2) : null;

                    const formatTime = (d) => {
                        if (!d) return "--:--:--";
                        return `${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}:${String(d.getSeconds()).padStart(2, '0')}`;
                    };

                    const datePart = dateStart ? `${dateStart.getFullYear()}-${String(dateStart.getMonth()+1).padStart(2, '0')}-${String(dateStart.getDate()).padStart(2, '0')}` : "---";
                    
                    let simpleType = 'OFF';
                    let typeName = o.send_url_name || 'Atak';
                    if (typeName.toUpperCase().includes('FAKE') || tInfo.fake) simpleType = 'FEJK';
                    if (typeName.toUpperCase().includes('GRUB') || o.nobleman > 0) simpleType = 'GRUBY';

                    orders.push({
                        id: internalId,
                        timeSort: dateStart ? dateStart.getTime() : 0,
                        date: datePart,
                        range: `${formatTime(dateStart)} - ${formatTime(dateEnd)}`,
                        source: o.start || '000|000',
                        target: tCoord,
                        type: typeName,
                        simpleType: simpleType,
                        link: o.send_url || '#',
                        note: `Off: ${o.off || 0}, Szl: ${o.nobleman || 0}, Kat: ${o.catapult || 0}`
                    });
                });
            });
        }

        function setView(view) {
            currentView = view;
            document.getElementById('btnVillage').className = view === 'village' ? 'nav-btn active' : 'nav-btn';
            document.getElementById('btnTime').className = view === 'time' ? 'nav-btn active' : 'nav-btn';
            render();
        }

        function render() {
            const app = document.getElementById('app');
            app.innerHTML = '';
            const pct = Math.round((doneIds.length / orders.length) * 100) || 0;
            document.getElementById('stats').innerText = `Postƒôp: ${doneIds.length} / ${orders.length} (${pct}%)`;
            document.getElementById('progFill').style.width = pct + '%';

            let sorted = [...orders].sort((a,b) => a.timeSort - b.timeSort);

            if (currentView === 'time') {
                sorted.forEach((o, index) => app.appendChild(createRow(o, index + 1)));
            } else {
                const sources = [...new Set(sorted.map(o => o.source))].sort();
                sources.forEach(src => {
                    const group = sorted.filter(o => o.source === src);
                    const header = document.createElement('div');
                    header.style = "color:#d3ad7f; margin-top:30px; border-bottom:1px solid #333; padding-bottom:5px; font-weight:bold; font-size: 1.2em;";
                    header.innerText = `üè† ≈πr√≥d≈Ço: ${src}`;
                    app.appendChild(header);
                    group.forEach(o => {
                        const globalIndex = sorted.findIndex(item => item.id === o.id) + 1;
                        app.appendChild(createRow(o, globalIndex));
                    });
                });
            }
        }

        function createRow(o, displayNum) {
            const isDone = doneIds.includes(o.id);
            const div = document.createElement('div');
            div.className = `order-row type-${o.simpleType} ${isDone ? 'done' : ''}`;
            
            div.innerHTML = `
                <div class="order-number">${displayNum}</div>
                <div class="time-cell">
                    <span class="date-part">WYSY≈ÅKA: ${o.date}</span>
                    <span class="time-range">${o.range}</span>
                </div>
                <div class="coord" onclick="copy('${o.source}')">${o.source}</div>
                <div style="text-align:center; color:#666">‚ûî</div>
                <div class="coord" onclick="copy('${o.target}')">${o.target}</div>
                <div>
                    <strong>${o.type}</strong>
                    <small style="display:block; color:#888">${o.note}</small>
                </div>
                <a href="${o.link}" target="_blank" class="link-btn ${o.simpleType === 'FEJK' ? 'btn-fake' : o.simpleType === 'GRUBY' ? 'btn-nob' : 'btn-off'}">OTW√ìRZ</a>
                <button class="action-btn" onclick="toggleDone(${o.id})">${isDone ? 'Cofnij' : '‚úÖ'}</button>
            `;
            return div;
        }

        function copy(t) { 
            navigator.clipboard.writeText(t);
        }

        function resetData() { 
            if(confirm("Czy na pewno chcesz usunƒÖƒá obecny plan i zaczƒÖƒá od nowa?")) { 
                localStorage.clear(); 
                location.reload(); 
            } 
        }

        function toggleDone(id) {
            if (doneIds.includes(id)) doneIds = doneIds.filter(x => x !== id);
            else doneIds.push(id);
            localStorage.setItem('tw_done_ids', JSON.stringify(doneIds));
            render();
        }
    </script>
</body>
</html>
